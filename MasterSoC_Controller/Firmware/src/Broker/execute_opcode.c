#include "parser.h" 
#include "parser_typedefs.h" 

/**
 * @brief Executes the callback function for a given opcode.
 *
 * This function retrieves the OpcodeDescriptor for the given opcode, validates
 * the number of parameters, and dynamically calls the callback function with
 * the arguments provided in the buffer.
 *
 * @param opcode The opcode to execute.
 * @param buffer An array of Geric_Parameter containing the arguments.
 * @param buffer_size The number of arguments in the buffer.
 * @return int Returns 0 on success, or an error code on failure.
 */
int executeOpcode(LMS7002M_t *lms, uint32_t opcode, Geric_Parameter* buffer, size_t buffer_size) {
    // Retrieve the descriptor for the given opcode
    OpcodeDescriptor* descriptor = getOpcodeDescriptor(opcode);
    if (descriptor == NULL) {
        fprintf(stderr, "Error: Opcode 0x%X not found.\n", opcode);
        return -1; // Opcode not found
    }

    // Validate the number of parameters
    if (descriptor->num_params != buffer_size) {
        fprintf(stderr, "Error: Invalid number of arguments for opcode 0x%X. Expected %d, got %zu.\n",
                opcode, descriptor->num_params, buffer_size);
        return -2; // Invalid number of arguments
    }

    // Ensure the callback function is defined
    if (descriptor->callback == NULL) {
        fprintf(stderr, "Error: No callback defined for opcode 0x%X.\n", opcode);
        return -3; // No callback defined
    }

    // Dynamically call the callback function based on the number of parameters
    switch (descriptor->num_params) {
        case 1: {
          switch (opcode): { 
            /************************************************************************************************************************************************************************************
			* LMS7002M_create
			************************************************************************************************************************************************************************************/
            case 0x0:
              ((create_num_callback*)descriptor->callback)(NULL);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_set_gfir_taps
			************************************************************************************************************************************************************************************/
            case 0xD:
              ((set_gfir_taps_num_callback*)descriptor->callback)(lms);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_destroy
			* LMS7002M_power_down
			* LMS7002M_regs
			* LMS7002M_regs_to_rfic
			* LMS7002M_reset
			* LMS7002M_rfic_to_regs
			* LMS7002M_setup_digital_loopback
			************************************************************************************************************************************************************************************/
            case 0x1, 0x21, 0x41, 0x61, 0x81, 0xA1, 0xC1:
              ((one_param_lms7002m_t_num_callback*)descriptor->callback)(lms);
              break;

            } 
            break;
        }
        case 2: {
          switch (opcode): { 
            /************************************************************************************************************************************************************************************
			* LMS7002M_dump_ini
			* LMS7002M_load_ini
			************************************************************************************************************************************************************************************/
            case 0x24, 0x4:
              ((ini_num_callback*)descriptor->callback)(lms, buffer[1].value.string);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_spi_read
			************************************************************************************************************************************************************************************/
            case 0x3:
              ((spi_config_num_callback*)descriptor->callback)(lms, buffer[1].value.const_int);
              break;

            /************************************************************************************************************************************************************************************
			* rx_cal_init
			* tx_cal_init
			************************************************************************************************************************************************************************************/
            case 0xA7, 0xC7:
              ((one_param_lms7002m_chan_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_rxtsp_read_rssi
			************************************************************************************************************************************************************************************/
            case 0x18:
              ((readrssi_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_reset_lml_fifo
			* LMS7002M_set_mac_dir
			************************************************************************************************************************************************************************************/
            case 0x27, 0x7:
              ((one_param_lms7002m_chan_num_callback*)descriptor->callback)(lms, buffer[1].value.const_dir);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_invert_fclk
			* LMS7002M_sxt_to_sxr
			* LMS7002M_xbuf_enable_bias
			* LMS7002M_xbuf_share_tx
			************************************************************************************************************************************************************************************/
            case 0x26, 0x46, 0x6, 0x66:
              ((one_param_const_bool_num_callback*)descriptor->callback)(lms, buffer[1].value.const_bool);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_regs_spi_read
			* LMS7002M_regs_spi_write
			* LMS7002M_set_spi_mode
			************************************************************************************************************************************************************************************/
            case 0x23, 0x43, 0x63:
              ((spi_config_num_callback*)descriptor->callback)(lms, buffer[1].value.const_int);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_rxtsp_tsg_tone
			* LMS7002M_set_mac_ch
			* LMS7002M_txtsp_tsg_tone
			************************************************************************************************************************************************************************************/
            case 0x47, 0x67, 0x87:
              ((one_param_lms7002m_chan_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan);
              break;

            } 
            break;
        }
        case 3: {
          switch (opcode): { 
            /************************************************************************************************************************************************************************************
			* LMS7002M_rbb_set_pga
			* LMS7002M_rfe_set_lna
			* LMS7002M_rfe_set_loopback_lna
			* LMS7002M_rfe_set_tia
			* LMS7002M_trf_set_loopback_pad
			* LMS7002M_trf_set_pad
			************************************************************************************************************************************************************************************/
            case 0x57, 0x77, 0x97, 0xB7, 0xD7, 0xF7:
              ((trf_rbb_rfe_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, buffer[2].value.const_double);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_sxx_enable
			************************************************************************************************************************************************************************************/
            case 0xF:
              ((two_param_lms_const_bool_num_callback*)descriptor->callback)(lms, buffer[1].value.const_dir, buffer[2].value.const_bool);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_set_diq_mux
			************************************************************************************************************************************************************************************/
            case 0x8:
              ((two_param_lms7002m_dir_int_num_callback*)descriptor->callback)(lms, buffer[1].value.const_dir, buffer[2].value.const_int);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_ldo_enable
			************************************************************************************************************************************************************************************/
            case 0x9:
              ((ldo_enable_num_callback*)descriptor->callback)(lms, buffer[1].value.const_bool, buffer[2].value.const_int);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_spi_write
			************************************************************************************************************************************************************************************/
            case 0x2:
              ((spi_write_num_callback*)descriptor->callback)(lms, buffer[1].value.const_int, buffer[2].value.const_int);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_rbb_enable
			* LMS7002M_rbb_set_test_out
			* LMS7002M_rfe_enable
			* LMS7002M_rxtsp_enable
			* LMS7002M_tbb_enable
			* LMS7002M_trf_enable
			* LMS7002M_trf_enable_loopback
			* LMS7002M_txtsp_enable
			************************************************************************************************************************************************************************************/
            case 0x10F, 0x2F, 0x4F, 0x6F, 0x8F, 0xAF, 0xCF, 0xEF:
              ((two_param_lms_const_bool_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, buffer[2].value.const_bool);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_rxtsp_set_freq
			* LMS7002M_txtsp_set_freq
			************************************************************************************************************************************************************************************/
            case 0x17, 0x37:
              ((trf_rbb_rfe_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, buffer[2].value.const_double);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_rbb_set_path
			* LMS7002M_rfe_set_path
			* LMS7002M_tbb_set_path
			* LMS7002M_tbb_set_test_in
			* LMS7002M_trf_select_band
			************************************************************************************************************************************************************************************/
            case 0x14, 0x34, 0x54, 0x74, 0x94:
              ((set_path_and_band_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, buffer[2].value.const_int);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_rxtsp_set_decim
			* LMS7002M_txtsp_set_interp
			************************************************************************************************************************************************************************************/
            case 0x10, 0x30:
              ((two_param_chant_sizet_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, NULL);
              break;

            } 
            break;
        }
        case 4: {
          switch (opcode): { 
            /************************************************************************************************************************************************************************************
			* LMS7002M_set_data_clock
			************************************************************************************************************************************************************************************/
            case 0xB:
              ((set_data_clock_num_callback*)descriptor->callback)(lms, buffer[1].value.const_double, buffer[2].value.const_double, buffer[3].value.double_ptr);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_rbb_set_filter_bw
			* LMS7002M_tbb_set_filter_bw
			************************************************************************************************************************************************************************************/
            case 0x16, 0x36:
              ((bb_filer_set_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, buffer[2].value.const_double, buffer[3].value.double_ptr);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_afe_enable
			************************************************************************************************************************************************************************************/
            case 0xA:
              ((afe_enable_num_callback*)descriptor->callback)(lms, buffer[1].value.const_dir, buffer[2].value.const_chan, buffer[3].value.const_bool);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_set_nco_freq
			************************************************************************************************************************************************************************************/
            case 0xC:
              ((set_nco_freq_num_callback*)descriptor->callback)(lms, buffer[1].value.const_dir, buffer[2].value.const_chan, buffer[3].value.const_double);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_configure_lml_port
			************************************************************************************************************************************************************************************/
            case 0x5:
              ((configure_lml_port_num_callback*)descriptor->callback)(lms, buffer[1].value.const_port, buffer[2].value.const_dir, buffer[3].value.const_int);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_tbb_enable_loopback
			************************************************************************************************************************************************************************************/
            case 0x15:
              ((tbb_loop_back_enable_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, buffer[2].value.const_int, buffer[3].value.const_bool);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_rxtsp_tsg_const
			* LMS7002M_txtsp_tsg_const
			************************************************************************************************************************************************************************************/
            case 0x11, 0x31:
              ((sp_tsg_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, buffer[2].value.const_int, buffer[3].value.const_int);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_rxtsp_set_dc_correction
			* LMS7002M_rxtsp_set_iq_correction
			************************************************************************************************************************************************************************************/
            case 0x13, 0x33:
              ((rxtsp_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, buffer[2].value.const_bool, buffer[3].value.const_int);
              break;

            /************************************************************************************************************************************************************************************
			* LMS7002M_txtsp_set_dc_correction
			* LMS7002M_txtsp_set_iq_correction
			************************************************************************************************************************************************************************************/
            case 0x12, 0x32:
              ((txstp_correction_num_callback*)descriptor->callback)(lms, buffer[1].value.const_chan, buffer[2].value.const_double, buffer[3].value.const_double);
              break;

            } 
            break;
        }
        case 5: {
          switch (opcode): { 
            /************************************************************************************************************************************************************************************
			* LMS7002M_set_lo_freq
			************************************************************************************************************************************************************************************/
            case 0xE:
              ((set_lo_freq_num_callback*)descriptor->callback)(lms, buffer[1].value.const_dir, buffer[2].value.const_double, buffer[3].value.const_double, buffer[4].value.double_ptr);
              break;

            } 
            break;
        }
        default:
            fprintf(stderr, "Error: Unsupported number of parameters (%d) for opcode 0x%X.\n",
                    descriptor->num_params, opcode);
            return -4; // Unsupported number of parameters
    }

    return 0; // Success
}
